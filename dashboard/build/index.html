<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Paper Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #111827; color: #e2e8f0; font-family: system-ui, sans-serif; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .flash-green { animation: flashGreen 0.5s ease-out; }
        .flash-red { animation: flashRed 0.5s ease-out; }
        @keyframes flashGreen { 0% { background: rgba(34, 197, 94, 0.3); } 100% { background: transparent; } }
        @keyframes flashRed { 0% { background: rgba(239, 68, 68, 0.3); } 100% { background: transparent; } }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-3">
                    <span class="text-3xl">üìà</span>
                    Crypto Paper Trading
                </h1>
                <p class="text-gray-500 mt-1">15-Min Binary Simulation + 2x Leverage</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-xs text-gray-500">Last update</div>
                    <div id="lastUpdate" class="text-sm text-gray-400">--:--:--</div>
                </div>
                <div class="w-3 h-3 bg-green-400 rounded-full pulse"></div>
            </div>
        </div>

        <!-- Live Crypto Prices -->
        <div class="flex gap-4 mb-6 flex-wrap" id="cryptoPrices">
            <div class="bg-gray-800/50 rounded-lg px-4 py-3 flex items-center gap-3">
                <span class="text-orange-400 font-bold">BTC</span>
                <div>
                    <div id="priceBTC" class="font-mono font-bold">$--</div>
                    <div id="changeBTC" class="text-xs text-gray-500">--%</div>
                </div>
                <div id="rsiBTC" class="text-xs px-2 py-1 rounded bg-gray-700">RSI --</div>
                <div id="signalBTC" class="text-xs px-2 py-1 rounded bg-gray-700">--</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg px-4 py-3 flex items-center gap-3">
                <span class="text-blue-400 font-bold">ETH</span>
                <div>
                    <div id="priceETH" class="font-mono font-bold">$--</div>
                    <div id="changeETH" class="text-xs text-gray-500">--%</div>
                </div>
                <div id="rsiETH" class="text-xs px-2 py-1 rounded bg-gray-700">RSI --</div>
                <div id="signalETH" class="text-xs px-2 py-1 rounded bg-gray-700">--</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg px-4 py-3 flex items-center gap-3">
                <span class="text-purple-400 font-bold">SOL</span>
                <div>
                    <div id="priceSOL" class="font-mono font-bold">$--</div>
                    <div id="changeSOL" class="text-xs text-gray-500">--%</div>
                </div>
                <div id="rsiSOL" class="text-xs px-2 py-1 rounded bg-gray-700">RSI --</div>
                <div id="signalSOL" class="text-xs px-2 py-1 rounded bg-gray-700">--</div>
            </div>
        </div>

        <!-- Overall Stats -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-6">
            <div class="bg-gray-800/50 rounded-lg p-3">
                <div class="text-gray-400 text-xs uppercase">Bankroll</div>
                <div id="bankroll" class="text-xl font-bold text-blue-400">$1,000</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-3">
                <div class="text-gray-400 text-xs uppercase">Total P&L</div>
                <div id="totalPnl" class="text-xl font-bold">$0.00</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-3">
                <div class="text-gray-400 text-xs uppercase">Unrealized</div>
                <div id="unrealizedPnl" class="text-xl font-bold text-yellow-400">$0.00</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-3">
                <div class="text-gray-400 text-xs uppercase">Win Rate</div>
                <div id="winRate" class="text-xl font-bold">--%</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-3">
                <div class="text-gray-400 text-xs uppercase">Total Trades</div>
                <div id="totalTrades" class="text-xl font-bold">0</div>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-3">
                <div class="text-gray-400 text-xs uppercase">Open</div>
                <div id="openTrades" class="text-xl font-bold text-yellow-400">0</div>
            </div>
        </div>

        <!-- Split: Binary vs Leverage -->
        <div class="grid lg:grid-cols-2 gap-6">
            <!-- 15-Min Binary Simulation -->
            <div class="border-2 border-purple-500/50 bg-purple-500/5 rounded-xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <span>üé≤</span> 15-Min Binary
                    </h2>
                    <div class="text-right">
                        <div id="pmStats" class="text-xs text-gray-500">0W / 0L</div>
                        <div id="pmPnl" class="font-bold text-green-400">$0.00</div>
                    </div>
                </div>
                
                <div class="text-xs text-purple-300 mb-3 flex gap-4">
                    <span>‚è±Ô∏è 15-min window</span>
                    <span>üéØ Binary outcome</span>
                    <span>üí∞ Kelly-scaled bets</span>
                </div>
                
                <div class="mb-4">
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">Open Bets</h3>
                    <div id="pmOpenPositions" class="space-y-2 max-h-48 overflow-y-auto">
                        <div class="text-center py-3 text-gray-500 text-sm bg-gray-900/30 rounded-lg">No open bets</div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">Recent Results</h3>
                    <div id="pmClosedPositions" class="space-y-2 max-h-36 overflow-y-auto">
                        <div class="text-center py-2 text-gray-500 text-sm">No results yet</div>
                    </div>
                </div>
            </div>

            <!-- 2x Leverage Trading -->
            <div class="border-2 border-orange-500/50 bg-orange-500/5 rounded-xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <span>üöÄ</span> 2x Leverage
                    </h2>
                    <div class="text-right">
                        <div id="lvStats" class="text-xs text-gray-500">0W / 0L</div>
                        <div id="lvPnl" class="font-bold text-green-400">$0.00</div>
                    </div>
                </div>
                
                <div class="text-xs text-orange-300 mb-3 flex gap-4 flex-wrap">
                    <span>üìà Trail: 1.5%</span>
                    <span>üõë SL: -3%</span>
                    <span>üìä Signal exit</span>
                    <span>‚è±Ô∏è Max: 2h</span>
                </div>
                
                <div class="mb-4">
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">Open Positions (Live P&L)</h3>
                    <div id="lvOpenPositions" class="space-y-2 max-h-48 overflow-y-auto">
                        <div class="text-center py-3 text-gray-500 text-sm bg-gray-900/30 rounded-lg">No open positions</div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">Closed Trades</h3>
                    <div id="lvClosedPositions" class="space-y-2 max-h-36 overflow-y-auto">
                        <div class="text-center py-2 text-gray-500 text-sm">No results yet</div>
                    </div>
                </div>
                
                <div id="exitBreakdown" class="mt-3 p-2 bg-gray-800/50 rounded-lg hidden">
                    <div class="text-xs text-gray-400 flex gap-4 flex-wrap">
                        <span>üìà Trail: <span id="trailCount">0</span></span>
                        <span>üõë SL: <span id="slCount">0</span></span>
                        <span>üìä Signal: <span id="sigCount">0</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Info -->
        <div class="mt-6 bg-gray-800/30 rounded-xl p-4 border border-gray-700/50">
            <h3 class="font-bold mb-3">Strategy Details</h3>
            <div class="grid md:grid-cols-3 gap-4 text-sm">
                <div>
                    <div class="text-gray-400 mb-1">Entry Signal</div>
                    <div class="text-gray-300">RSI &lt;35 (buy) / &gt;65 (sell)</div>
                </div>
                <div>
                    <div class="text-gray-400 mb-1">Position Sizing (Kelly)</div>
                    <div class="text-gray-300">Base: 5% bankroll, Max: 25%</div>
                </div>
                <div>
                    <div class="text-gray-400 mb-1">Confidence Scaling</div>
                    <div class="text-gray-300">55% conf = 5%, 85% conf = 25%</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-gray-600 text-sm">
            <div>Auto-trades every minute ‚Ä¢ Prices update every 2 seconds ‚Ä¢ Paper trading mode</div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://oukirnoonygvvctrjmih.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91a2lybm9vbnlndnZjdHJqbWloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MzA3NTgsImV4cCI6MjA3MzMwNjc1OH0.8CFre4n9P2i8sQZtIBlhbdHa8x3NXAabIxfPi_1yaH4';
        const SIGNAL_URL = `${SUPABASE_URL}/functions/v1/generate-live-signal`;
        
        const STARTING_BANKROLL = 1000;
        const BASE_POSITION_PCT = 0.05;  // 5% base
        const MAX_POSITION_PCT = 0.25;   // 25% max
        const LEVERAGE = 2;
        
        let currentPrices = {};
        let currentBankroll = STARTING_BANKROLL;
        
        function formatPnl(pnl) {
            const sign = pnl >= 0 ? '+' : '';
            return `${sign}$${pnl.toFixed(2)}`;
        }
        
        function formatPnlPercent(pct) {
            const sign = pct >= 0 ? '+' : '';
            return `${sign}${pct.toFixed(2)}%`;
        }

        function getRsiBadgeClass(rsi) {
            if (rsi < 35) return 'bg-green-500/20 text-green-400';
            if (rsi > 65) return 'bg-red-500/20 text-red-400';
            return 'bg-gray-700 text-gray-400';
        }

        function getSignalBadge(direction) {
            if (direction === 'UP') return '<span class="px-2 py-1 rounded bg-green-500/20 text-green-400">‚Üë UP</span>';
            if (direction === 'DOWN') return '<span class="px-2 py-1 rounded bg-red-500/20 text-red-400">‚Üì DOWN</span>';
            return '<span class="px-2 py-1 rounded bg-gray-700 text-gray-400">‚Äî HOLD</span>';
        }

        function calcPositionSize(confidence, bankroll) {
            // Scale from 5% at 55% conf to 25% at 85% conf
            const confRange = 0.85 - 0.55;
            const sizeRange = MAX_POSITION_PCT - BASE_POSITION_PCT;
            const confNorm = Math.max(0, Math.min(1, (confidence - 0.55) / confRange));
            const sizePct = BASE_POSITION_PCT + (confNorm * sizeRange);
            return Math.round(bankroll * sizePct);
        }

        function getExitBadge(reason) {
            if (!reason) return '';
            if (reason.startsWith('trailing')) return '<span class="text-xs px-1.5 py-0.5 rounded bg-green-500/20 text-green-400">üìà</span>';
            if (reason.startsWith('stop_loss')) return '<span class="text-xs px-1.5 py-0.5 rounded bg-red-500/20 text-red-400">üõë</span>';
            if (reason.startsWith('signal')) return '<span class="text-xs px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400">üìä</span>';
            if (reason.includes('expiry')) return '<span class="text-xs px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-400">‚è±Ô∏è</span>';
            return '';
        }

        function renderPosition(trade, isOpen, type) {
            const symbol = trade.asset.replace('USDT', '');
            const isUp = trade.direction === 'UP';
            const leverage = type === 'lv' ? LEVERAGE : 1;
            const posSize = calcPositionSize(trade.confidence || 0.6, currentBankroll);
            
            if (isOpen) {
                const currentPrice = currentPrices[trade.asset];
                const entryPrice = parseFloat(trade.entry_price);
                let pnlPercent = currentPrice ? ((currentPrice - entryPrice) / entryPrice) * 100 : 0;
                if (trade.direction === 'DOWN') pnlPercent = -pnlPercent;
                pnlPercent *= leverage;
                const pnlDollar = (pnlPercent / 100) * posSize;
                const isProfit = pnlDollar >= 0;
                
                const elapsed = Math.floor((Date.now() - new Date(trade.entry_time).getTime()) / 60000);
                const timeInfo = type === 'pm' ? `${Math.max(0, 15 - elapsed)}m left` : `${elapsed}m`;
                
                return `
                    <div class="p-3 rounded-lg border ${isProfit ? 'border-green-500/30 bg-green-900/10' : 'border-red-500/30 bg-red-900/10'}" data-asset="${trade.asset}" data-entry="${trade.entry_price}" data-direction="${trade.direction}" data-conf="${trade.confidence || 0.6}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${isUp ? 'text-green-400' : 'text-red-400'}">${symbol} ${trade.direction}</span>
                                <span class="text-xs text-gray-500">${timeInfo}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-mono font-bold ${isProfit ? 'text-green-400' : 'text-red-400'} live-pnl">${formatPnl(pnlDollar)}</div>
                                <div class="text-xs ${isProfit ? 'text-green-500' : 'text-red-500'}">${formatPnlPercent(pnlPercent)}</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1 flex justify-between">
                            <span>$${posSize} @ $${entryPrice.toLocaleString()}</span>
                            <span>${((trade.confidence || 0.6) * 100).toFixed(0)}% conf</span>
                        </div>
                    </div>
                `;
            } else {
                const pnlPct = parseFloat(trade.pnl_percent) || 0;
                const pnlDollar = (pnlPct / 100) * posSize;
                const won = trade.won;
                return `
                    <div class="p-2 rounded-lg border ${won ? 'bg-green-900/20 border-green-700/30' : 'bg-red-900/20 border-red-700/30'} flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="${isUp ? 'text-green-400' : 'text-red-400'}">${symbol}</span>
                            ${getExitBadge(trade.exit_reason)}
                            <span class="text-xs text-gray-500">$${posSize}</span>
                        </div>
                        <span class="font-bold ${won ? 'text-green-400' : 'text-red-400'}">${won ? '‚úÖ' : '‚ùå'} ${formatPnl(pnlDollar)}</span>
                    </div>
                `;
            }
        }

        async function fetchData() {
            try {
                // Get signals
                const signalResp = await fetch(SIGNAL_URL);
                const signalData = await signalResp.json();
                
                if (signalData.signals) {
                    for (const asset of ['BTC', 'ETH', 'SOL']) {
                        const sig = signalData.signals[asset];
                        if (sig) {
                            document.getElementById('price' + asset).textContent = '$' + sig.currentPrice.toLocaleString();
                            
                            const rsiEl = document.getElementById('rsi' + asset);
                            rsiEl.textContent = `RSI ${sig.rsi.toFixed(0)}`;
                            rsiEl.className = `text-xs px-2 py-1 rounded ${getRsiBadgeClass(sig.rsi)}`;
                            
                            document.getElementById('signal' + asset).innerHTML = getSignalBadge(sig.direction);
                            
                            currentPrices[asset + 'USDT'] = sig.currentPrice;
                        }
                    }
                }
                
                // Get paper trades
                const headers = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` };
                
                const [pmOpenResp, pmClosedResp, lvOpenResp, lvClosedResp] = await Promise.all([
                    fetch(`${SUPABASE_URL}/rest/v1/paper_trades?trade_type=eq.polymarket&exit_time=is.null&order=entry_time.desc`, { headers }),
                    fetch(`${SUPABASE_URL}/rest/v1/paper_trades?trade_type=eq.polymarket&exit_time=not.is.null&order=exit_time.desc&limit=10`, { headers }),
                    fetch(`${SUPABASE_URL}/rest/v1/paper_trades?trade_type=eq.leverage&exit_time=is.null&order=entry_time.desc`, { headers }),
                    fetch(`${SUPABASE_URL}/rest/v1/paper_trades?trade_type=eq.leverage&exit_time=not.is.null&order=exit_time.desc&limit=10`, { headers })
                ]);
                
                const pmOpen = await pmOpenResp.json();
                const pmClosed = await pmClosedResp.json();
                const lvOpen = await lvOpenResp.json();
                const lvClosed = await lvClosedResp.json();
                
                // Render positions
                document.getElementById('pmOpenPositions').innerHTML = pmOpen.length > 0
                    ? pmOpen.map(t => renderPosition(t, true, 'pm')).join('')
                    : '<div class="text-center py-3 text-gray-500 text-sm bg-gray-900/30 rounded-lg">No open bets</div>';
                    
                document.getElementById('pmClosedPositions').innerHTML = pmClosed.length > 0
                    ? pmClosed.map(t => renderPosition(t, false, 'pm')).join('')
                    : '<div class="text-center py-2 text-gray-500 text-sm">No results yet</div>';
                
                document.getElementById('lvOpenPositions').innerHTML = lvOpen.length > 0
                    ? lvOpen.map(t => renderPosition(t, true, 'lv')).join('')
                    : '<div class="text-center py-3 text-gray-500 text-sm bg-gray-900/30 rounded-lg">No open positions</div>';
                    
                document.getElementById('lvClosedPositions').innerHTML = lvClosed.length > 0
                    ? lvClosed.map(t => renderPosition(t, false, 'lv')).join('')
                    : '<div class="text-center py-2 text-gray-500 text-sm">No results yet</div>';
                
                // Stats
                const allClosed = [...pmClosed, ...lvClosed];
                const pmWins = pmClosed.filter(t => t.won).length;
                const lvWins = lvClosed.filter(t => t.won).length;
                const wins = pmWins + lvWins;
                const winRate = allClosed.length > 0 ? (wins / allClosed.length * 100).toFixed(1) : '--';
                
                let pmPnl = 0, lvPnl = 0;
                pmClosed.forEach(t => { 
                    const size = calcPositionSize(t.confidence || 0.6, STARTING_BANKROLL);
                    pmPnl += (parseFloat(t.pnl_percent) || 0) / 100 * size; 
                });
                lvClosed.forEach(t => { 
                    const size = calcPositionSize(t.confidence || 0.6, STARTING_BANKROLL);
                    lvPnl += (parseFloat(t.pnl_percent) || 0) / 100 * size; 
                });
                
                const totalPnl = pmPnl + lvPnl;
                currentBankroll = STARTING_BANKROLL + totalPnl;
                
                // Calculate unrealized
                let unrealized = 0;
                [...lvOpen].forEach(t => {
                    const price = currentPrices[t.asset];
                    if (price) {
                        let pct = ((price - t.entry_price) / t.entry_price) * 100;
                        if (t.direction === 'DOWN') pct = -pct;
                        pct *= LEVERAGE;
                        unrealized += (pct / 100) * calcPositionSize(t.confidence || 0.6, currentBankroll);
                    }
                });
                
                document.getElementById('bankroll').textContent = '$' + currentBankroll.toFixed(0);
                document.getElementById('totalPnl').textContent = formatPnl(totalPnl);
                document.getElementById('totalPnl').className = `text-xl font-bold ${totalPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
                document.getElementById('unrealizedPnl').textContent = formatPnl(unrealized);
                document.getElementById('unrealizedPnl').className = `text-xl font-bold ${unrealized >= 0 ? 'text-green-400' : 'text-red-400'}`;
                document.getElementById('winRate').textContent = winRate + '%';
                document.getElementById('totalTrades').textContent = allClosed.length;
                document.getElementById('openTrades').textContent = pmOpen.length + lvOpen.length;
                
                document.getElementById('pmStats').textContent = `${pmWins}W / ${pmClosed.length - pmWins}L`;
                document.getElementById('pmPnl').textContent = formatPnl(pmPnl);
                document.getElementById('pmPnl').className = `font-bold ${pmPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
                
                document.getElementById('lvStats').textContent = `${lvWins}W / ${lvClosed.length - lvWins}L`;
                document.getElementById('lvPnl').textContent = formatPnl(lvPnl);
                document.getElementById('lvPnl').className = `font-bold ${lvPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
                
                // Exit breakdown
                if (lvClosed.length > 0) {
                    const trails = lvClosed.filter(t => t.exit_reason?.startsWith('trailing')).length;
                    const sls = lvClosed.filter(t => t.exit_reason?.startsWith('stop_loss')).length;
                    const sigs = lvClosed.filter(t => t.exit_reason?.startsWith('signal')).length;
                    document.getElementById('trailCount').textContent = trails;
                    document.getElementById('slCount').textContent = sls;
                    document.getElementById('sigCount').textContent = sigs;
                    document.getElementById('exitBreakdown').classList.remove('hidden');
                }
                
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (err) {
                console.error('Error:', err);
            }
        }

        // Initial load
        fetchData();
        setInterval(fetchData, 5000);
    </script>
</body>
</html>
